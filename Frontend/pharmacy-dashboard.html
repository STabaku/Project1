<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pharmacy Dashboard</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  display: flex;
}

/* SIDEBAR */
.sidebar {
  width: 240px;
  background: #1e293b;
  color: white;
  height: 100vh;
  padding: 20px;
}

.sidebar h2 {
  margin-bottom: 30px;
  text-align: center;
}

.sidebar a {
  display: block;
  padding: 12px;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  margin-bottom: 8px;
}

.sidebar a:hover {
  background: #334155;
}

/* MAIN */
.main {
  flex: 1;
  padding: 30px;
}

.topbar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 30px;
}

.card-box {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
  text-align: center;
}

.card h3 {
  margin: 0;
  font-size: 26px;
}

.section {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 30px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

table th, table td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  text-align: center;
}

.status-pending { color: orange; font-weight: bold; }
.status-accepted { color: green; font-weight: bold; }
.status-delivered { color: blue; font-weight: bold; }

.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.btn-accept { background: #16a34a; color: white; }
.btn-done { background: #2563eb; color: white; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>Pharmacy Panel</h2>
  <a href="#" onclick="showSection('overview')">Dashboard</a>
  <a href="#" onclick="showSection('new')">New Requests</a>
  <a href="#" onclick="showSection('active')">Active Orders</a>
  <a href="#" onclick="showSection('history')">History</a>
  <a href="#" onclick="showSection('profile')">Profile</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<!-- MAIN -->
<div class="main">

  <!-- TOP BAR -->
  <div class="topbar">
    <h2 id="pharmacyName">City Pharmacy Dashboard</h2>
    <span id="pharmacyEmail">city@pharmacy.com</span>
  </div>

  <!-- OVERVIEW -->
  <div id="overview" class="section">
    <h3>Overview</h3>
    <div class="card-box">
      <div class="card"><h3 id="totalReq">0</h3><p>Total Requests</p></div>
      <div class="card"><h3 id="pendingReq">0</h3><p>Pending</p></div>
      <div class="card"><h3 id="activeReq">0</h3><p>Active</p></div>
      <div class="card"><h3 id="doneReq">0</h3><p>Delivered</p></div>
    </div>
  </div>

  <!-- NEW REQUESTS -->
  <div id="new" class="section" style="display:none;">
    <h3>New Emergency Requests</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Medicine</th>
          <th>Qty</th>
          <th>Address</th>
          <th>Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="newRequests"></tbody>
    </table>
  </div>

  <!-- ACTIVE ORDERS -->
  <div id="active" class="section" style="display:none;">
    <h3>Active Orders</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Medicine</th>
          <th>Qty</th>
          <th>Address</th>
          <th>Status</th>
          <th>Finish</th>
        </tr>
      </thead>
      <tbody id="activeOrders"></tbody>
    </table>
  </div>

  <!-- HISTORY -->
  <div id="history" class="section" style="display:none;">
    <h3>Order History</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Medicine</th>
          <th>Qty</th>
          <th>Address</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="historyOrders"></tbody>
    </table>
  </div>

  <!-- PROFILE -->
  <div id="profile" class="section" style="display:none;">
    <h3>Pharmacy Profile</h3>
    <p><strong>Name:</strong> City Pharmacy</p>
    <p><strong>Email:</strong> city@pharmacy.com</p>
    <p><strong>Location:</strong> Prishtina</p>
  </div>

</div>

<script>
   
const BASE_URL = "http://localhost:5183";
const token = localStorage.getItem("token");

if (!token) {
  alert("Not authenticated");
  window.location.href = "index.html";
}

function showSection(id) {
  document.querySelectorAll(".section").forEach(s => {
    s.style.display = "none";
  });
  document.getElementById(id).style.display = "block";
}

function logout() {
  localStorage.removeItem("token");
  window.location.href = "index.html";
}

/* ================================
   LOAD ALL REQUESTS (MAIN)
================================ */
async function loadRequests() {
  try {
    const res = await fetch(`${BASE_URL}/api/requests`, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    if (!res.ok) throw new Error("Failed to load requests");

    const data = await res.json();

    renderRequests(data);
    updateCounters(data);

  } catch (err) {
    console.error(err);
    alert("Error loading requests");
  }
}

function renderRequests(data) {
  const newT = document.getElementById("newRequests");
  const activeT = document.getElementById("activeOrders");
  const historyT = document.getElementById("historyOrders");

  newT.innerHTML = "";
  activeT.innerHTML = "";
  historyT.innerHTML = "";

  data.forEach(r => {

    /* NEW / PENDING */
    if (r.status === "Pending") {
      newT.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.medicineName}</td>
          <td>${r.quantity}</td>
          <td>${r.address}</td>
          <td>${formatDate(r.createdAt)}</td>
          <td>
            <button class="btn btn-accept" onclick="acceptRequest(${r.id})">
              Accept
            </button>
          </td>
        </tr>`;
    }

    /* ACTIVE / ACCEPTED */
    if (r.status === "Accepted") {
      activeT.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.medicineName}</td>
          <td>${r.quantity}</td>
          <td>${r.address}</td>
          <td class="status-accepted">Accepted</td>
          <td>
            <button class="btn btn-done" onclick="deliverRequest(${r.id})">
              Delivered
            </button>
          </td>
        </tr>`;
    }

    /* HISTORY / DELIVERED */
    if (r.status === "Delivered") {
      historyT.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.medicineName}</td>
          <td>${r.quantity}</td>
          <td>${r.address}</td>
          <td class="status-delivered">Delivered</td>
          <td>${formatDate(r.createdAt)}</td>
        </tr>`;
    }
  });
}

/* DASHBOARD COUNTERS */
function updateCounters(data) {
  const total = data.length;
  const pending = data.filter(r => r.status === "Pending").length;
  const active = data.filter(r => r.status === "Accepted").length;
  const delivered = data.filter(r => r.status === "Delivered").length;

  document.getElementById("totalReq").innerText = total;
  document.getElementById("pendingReq").innerText = pending;
  document.getElementById("activeReq").innerText = active;
  document.getElementById("doneReq").innerText = delivered;
}

/*ACCEPT REQUEST */
async function acceptRequest(id) {
  if (!confirm("Accept this request?")) return;

  await fetch(`${BASE_URL}/api/requests/accept/${id}`, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token
    }
  });

  loadRequests();
}

/* ================================
   DELIVER REQUEST
================================ */
async function deliverRequest(id) {
  if (!confirm("Mark as delivered?")) return;

  await fetch(`${BASE_URL}/api/requests/deliver/${id}`, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token
    }
  });

  loadRequests();
}

/* ================================
   HELPERS
================================ */
function formatDate(date) {
  return new Date(date).toLocaleString();
}

/* ================================
   AUTO REFRESH
================================ */
loadRequests();
setInterval(loadRequests, 5000);
</script>
</body>
</html>
